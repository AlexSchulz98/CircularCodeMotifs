---
title: "On Mutations in Circular Code Motifs"
output: html_notebook
---

## Bibliotheken
```{r}
library(Biostrings)
library(ccmotif)
```

## Coding Sequence
Die Coding Sequenz (CDS) S ist eine RNA Sequenz mit Circular Code und Nicht-Circular-Code Motiven. Die Länge der Circular-Code-Motive soll maximiert werden.
```{r}
seqSet = readDNAStringSet("cds/ena-sars.fasta")
seq=seqSet[[11]]
#codonsSeq = codons(seq)
```

## Circular Codes
Codes.c3 umfasst 216 selbst-komplementäre C3 Codes, welche als vielversprechend gelten. Unter diesen 216 Codes sind auch solche, welche Stopp-Codons enthalten, welche zu einem Abbruch beim Lesen des RNA Strangs führen. Mathematisch gesehen sind diese Codes gleichzusetzten mit den Stopp-Codon freien Codes, biologisch gesehen sind diese aber nicht sinnvoll zu verwenden, weshalb wir nur mit Stopp-Codon freien Codes arbeiten werden. 
```{r}
setX = codes.c3[[26]] #Codes im List Format
setXString = unlist(setX)
setXString = strsplit(setXString, ",")
prefix = setXString[1]
setXString = setdiff(setXString,prefix) #Präfix entfernen
setXString = toString(setXString)
setXStringPure = gsub(", ","",setXString) #Kommas entfernen
setXDNAString = DNAString(setXStringPure) #in DNAString Format umwandeln. Nur so kann translate() benutzt werden

print(setXString)
```

## Methoden

### Randbedingungen

Es wird stets versucht die gleiche Aminosäure zu erhalten. Wenn dies nicht möglich ist, wird diese durch die an den biochemischen Eigenschaften gemessen ähnlichste Aminosäure ersetzt. 

Die Anzahl an Veränderungen bei einer Mutation soll in jedem Fall möglichst gering sein. 

### Richtung
Zunächst wird betrachtet wie viele Schritte von biologischen zu einer zirkulären Sequenz gebraucht werden.

Von zirkulären zu biologischen Sequenzen folgt .... #TODO

### Vorgehen
Von Interesse sind nur Codons, welche nicht Teil des circular codes sind. Diese werden in die entsprechende Aminosäure übersetzt. Dazu dient die Funktion translate() aus dem Biostring Package. Beispiel:

```{r}
rna = DNAString("GGT")
aa = translate(rna)
aaString = toString(aa)
print(aa)
```

Mit der gefundenen Aminosäure lässt sich eine Liste von Codons zurückgeben, welche ebenfalls für diese Aminosäure codieren.

```{r}
source("AminoDecoder.R")
codesForaa = getCodesForAA(aa)
print(codesForaa)
```

Es wird das Codon gesucht, welches auch Teil des Circular Codes ist. Wird eines gefunden, wird das alte Codon, durch das neue circular code Codon ersetzt.
TODO: Ersatz mit geringster Veränderung wählen. Dazu evtl Liste neuer Funktion übergeben

```{r}
codesForaa_size = length(codesForaa)

if (!is.null(codesForaa)) { #Bei eines Stopp Codon, wird eine leere Liste zurückgegeben
  
    for (j in codesForaa_size) {
      testCodon = codesForaa[j]
    
      if (grepl(testCodon, setXString)) {
        #Ersatz gefunden
        print(paste("Ersatz gefunden: ", testCodon))
        break()
      }
    }
  }
```

Sollte in der Liste kein Codon vorhanden sein, welches dem Kriterium entspricht, so suchen wir nach einer möglichst ähnlichen Aminosäure. Diese Aminosäure muss durch die Circular Codes codiert werden. Dazu lassen wir uns eine Liste dieser ausgeben:

```{r}
setXaa = translate(setXDNAString)
setXaa = uniqueLetters(setXaa)
print(setXaa)
```

Nun vergleichen wir die Aminosäure des Codons mit dieser Liste. Die Aminosäure mit der höchsten Übereinstimmung wird als Ersatz übernommen. 

TODO: Austausch werten

```{r}
data("BLOSUM62")
setXaa_length = length(setXaa)

#aaString = "P"

newAA = aaString # sollte sich keine Aminosäure mit score > 0 finden, wird die alte beibehalten
score = -5 # threshold

for (i in 1:setXaa_length) {
  tmp = BLOSUM62[aaString, setXaa[i]]
  if (tmp >= score) {
    score = tmp
    newAA = setXaa[i]
  }
}
print(paste(newAA, score))

```

Für die ganze Sequenz S ergibt sich folgendes: 

```{r}
newSequence = changeSequence(seq, setX)

print(setX) #circular code
print(toString(seq)) #oldSequence
print(newSequence)

counts = getStatistics()
print(paste("Insgesamt gab es", counts[1],"Codons."))
print(paste(counts[2],"waren nicht bereits Teil des ciruclar Codes."))
print(paste("Davon wurden",counts[3],"ersetzt durch Codons, welche Teil des cirular Codes sind."))
print(paste(counts[4],"sind CC-Codons anderer als der ursprünglichen Aminosäure"))

fileConn = file("output.txt") #newSequence to txt file
writeLines(newSequence, fileConn) 
close(fileConn)
```


