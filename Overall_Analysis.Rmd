---
title: "Overall Analysis"
author: "Alexander Schulz"
date: "4 2 2020"
output: html_document
---

```{r include=FALSE}
library("seqinr")
library("ggplot2")
library("ccmotif") # Version 0.6.6
library("Biostrings")
library("knitr")
source("Parameter.R")
```

Change here:
```{r}
pathSeq = "../BA Circular Code/output_sequences/"
filenames = list.files(pathSeq, pattern = "*.fasta")

pathMatrix = "../BA Circular Code/output_matrixes_codons/"
matrixnames = list.files(pathMatrix, pattern = "*.RDS")
```

Iterate through all files. Result is stored in data frame:
```{r echo=FALSE}
df = data.frame(Organism=c(),
                Code=c(),
                Frame=c(),
                Code_Usage=c(),
                Changed_Codons=c(),
                Sample_MML=c(),
                Expected_MML=c(),
                Diff_MML=c(),
                Edit_Score=c(),
                Edit_Distance=c())

for (i in 1:length(filenames)) { 
  
  ff = read.fasta(paste(pathSeq,filenames[i],sep=""), as.string = TRUE, forceDNAtolower = FALSE)
  rds = readRDS(paste(pathMatrix,matrixnames[i],sep=""))
  
  tmp = unlist(strsplit(filenames[i],"_"))
  organism = tmp[1]
  code = tmp[2]
  frame = unlist(strsplit(tmp[3],".fasta"))
  
  print(filenames[i])
  print(matrixnames[i])
  print(organism)
  print(code)
  print(frame)
  
  #Codon Distribution
  codons = codon.splitlist(ff)
  cu = codon.usage(codons)
  plot(cu, species = paste(organism,code,frame,sep="_"))
  
  #Code Usage
  p = codes.usage(cu, codes.c3[[as.numeric(code)]])
  print(paste("Achieved code Usage",round(p, 2)))
  
  #Amount of codons
  ca = sum(rds)
  print(paste("Amount of codons: ",ca))
  
  #Unchanged codons
  nc = sum(diag(rds))
  nc_p = nc/ca
  print(paste("Unchanged codons: ",nc, round(nc_p,2)))
  
  #Codons that could not be changed
  unc = unchangednonCCCodons(rds,codes.c3[[as.numeric(code)]])
  unc_p = unc/ca
  print(paste("--------- because no good subsitution: ",unc, round(unc_p,2)))
  
  #Codons that did no need to be changed
  ucc = nc-unc
  ucc_p = ucc/ca
  print(paste("--------- because part of code before: ",ucc, round(ucc_p,2)))
  
  #Changed codons
  cc = ca-nc
  cc_p = cc/ca
  print(paste("Changed codons: ",cc, round(cc_p,2)))
  
  #Average motif length:
  ml = ccmotif.lengthslist(ff, codes.c3[[as.numeric(code)]])
  print("Incode:")
  print(summary(ml$incode))
  print("Outcode:")
  print(summary(ml$outcode))
  
  #Motif length distribution: theoretical distribution (red) copared with the sample (blue):
  r = ccmotif.classes(ml$incode, p, K = 18)
  print(ccmotif.barplotDiff(r$sample, r$geom, codeid = paste(organism,code,frame,sep = "_")))
  
  #Expected mean value of the motif length vs real mean value:
  E = function(p) 1 / (1 - p)
  mmt = E(p)
  mm = mean(ml$incode)
  print(round(c(sample = mm, expected = mmt), digits = 2))
  mmd = mm-mmt
  
  #Edit Score and Edit Distance:
  editScore = getEditScore(rds)
  print(paste("Edit Score:",round(editScore,4)))
  editDistance = getEditDistance(rds,editScore,codes.c3[[as.numeric(code)]])
  print(paste("Edit Distance:",round(editDistance,2)))
  
  
  #Fill data frame
  tmp = data.frame(Organism=organism,
                  Code=code,
                  Frame=frame,
                  Code_Usage=round(p,2),
                  Changed_Codons=round(cc_p,2),
                  Sample_MML=round(mm,2),
                  Expected_MML=round(mmt,2),
                  Diff_MML=round(mmt,2),
                  Edit_Score=round(editScore,3),
                  Edit_Distance=round(editDistance,2))
  
  df = rbind(df,tmp)
}

names(df) = c("Organism","Code","Frame","Achieved Code Usage","% of Codons changed","Sample Mean Motif Lenght","Expected Mean Motif Lenght","Diff","Edit Score","Edit Distance")

```

Summary:
```{r}

kable(
  df,
  caption = paste("Summary for",organism)
)
```
```{r}
  saveRDS(
    object = df,
    file = "Summary_Analysis.RDS"
  )
```





#NÃ¼tzliche CCMotif Funktionen:
# ccmotif.scan.fasta --> Analysis of motif lengths in a list of fasta sequences (spuckt 3 datein aus)


